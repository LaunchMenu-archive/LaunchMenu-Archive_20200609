{"version":3,"sources":["../../../../../src/core/communication/data/globalData/globalData.js"],"names":["GlobalData","constructor","ID","dataListener","event","data","__setField","path","value","type","IPC","on","listeners","change","send","get","pathParts","split","field","shift","length","listener","index","indexOf","push","off","splice","dispose","_setData","pop","join","__emitEvent","fullPath","allData","subPath","forEach","call"],"mappings":"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","file":"globalData.js","sourcesContent":["import IPC from \"../../IPC\";\r\nexport default class GlobalData {\r\n    /**\r\n     * Create a new globalData object allowing you to share data between different modules\r\n     * @constructs GlobalData\r\n     * @hideconstructor\r\n     * @param {string} ID - The ID of the global data to synchronise with\r\n     */\r\n    constructor(ID) {\r\n        this.ID = ID;\r\n\r\n        // The IPC listener that checks data change evens\r\n        this.dataListener = event => {\r\n            const data = event.data;\r\n            this.__setField(data.path, data.value, data.type);\r\n        };\r\n        IPC.on(\"GlobalData.notifyChange.\" + ID, this.dataListener);\r\n\r\n        // The outside event listeners that will be called when data changes\r\n        this.listeners = {};\r\n    }\r\n\r\n    /**\r\n     * Changes the data by providing an object with the field you want to alter,\r\n     * The value 'undefined' can be used to delete a field\r\n     * @param {Object} data - The object with the altered fields\r\n     * @returns {Object} The currently saved data after the alteration\r\n     * @async\r\n     * @public\r\n     */\r\n    change(data) {\r\n        // Send data to main and spread it around from there\r\n        return IPC.send(\"GlobalData.change\", {\r\n            ID: this.ID,\r\n            data: data,\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Gets a specific property by specifying the path to said property\r\n     * @param {string} [path] - The path to the property\r\n     * @returns {*} The data saved under the specified field\r\n     * @public\r\n     */\r\n    get(path) {\r\n        if (!path) path = \"\";\r\n\r\n        // Get field list from the path\r\n        let pathParts = path.split(\".\");\r\n\r\n        let data = this.data;\r\n        let field;\r\n        // Get the next field as long as there is a next field\r\n        while ((field = pathParts.shift()) && data && field.length > 0)\r\n            data = data[field];\r\n\r\n        // Return the retrieved data\r\n        return data;\r\n    }\r\n\r\n    //TODO: specify the callback once VScode works prooperly with @callback\r\n    /**\r\n     * Adds a listener to the object which will get invoked when data changes\r\n     * @param {('update'|'delete'|'create'|'change')} type - The event type to listen to (may be prefexid by path E.G. 'field.subField.update')\r\n     * @param {function} listener - The function to call once a property has been changed\r\n     * @returns {undefined}\r\n     * @public\r\n     */\r\n    on(type, listener) {\r\n        // Get the listeners list for this event type, or create if non-existent\r\n        let listeners = this.listeners[type];\r\n        if (!listeners) listeners = this.listeners[type] = [];\r\n\r\n        // Check if the listener is already added, and add it if it isn't\r\n        const index = listeners.indexOf(listener);\r\n        if (index == -1) listeners.push(listener);\r\n    }\r\n\r\n    /**\r\n     * Removes a listener from the object which would have gotten invoked when data changes\r\n     * @param {('update'|'delete'|'create'|'change')} type - The event type that was listened to (may be prefexid by path E.G. 'field.subField.update')\r\n     * @param {function} listener - The function that was listening to said event type\r\n     * @returns {undefined}\r\n     * @public\r\n     */\r\n    off(type, listener) {\r\n        // Get the listeners list for this event type\r\n        const listeners = this.listeners[type];\r\n        if (listeners) {\r\n            // Check at what index this listener is stored, and remove said index\r\n            const index = listeners.indexOf(listener);\r\n            if (index != -1) listeners.splice(index, 1);\r\n\r\n            // If no more listeners exist, remove the list\r\n            if (listeners.length == 0) delete this.listeners[type];\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Gets rid of all connected data such that the object is safely removed\r\n     * @returns {undefined}\r\n     * @public\r\n     */\r\n    dispose() {\r\n        // Remove the IPC listener\r\n        IPC.off(\"GlobalData.notifyChange.\" + ID, this.dataListener);\r\n    }\r\n\r\n    /**\r\n     * Sets the initial data of the object, without sending events to other instances\r\n     * @param {Object} data - The data to store in the instance\r\n     * @returns {undefined}\r\n     * @protected\r\n     */\r\n    _setData(data) {\r\n        this.data = data;\r\n    }\r\n\r\n    /**\r\n     * Alters a local field and sends out an event to all listeners\r\n     * @param {string} path - The path to the field to change\r\n     * @param {*} value - The new value to store in the field\r\n     * @param {('delete'|'create'|'change')} type - The event type to execute\r\n     * @returns {undefined}\r\n     * @private\r\n     */\r\n    __setField(path, value, type) {\r\n        // Extract the field that was altered from the path\r\n        const pathParts = path.split(\".\");\r\n        const field = pathParts.pop();\r\n\r\n        // Get the object that contains the field\r\n        const data = this.get(pathParts.join(\".\"));\r\n        if (data) {\r\n            // Check if the event type was a deletion\r\n            if (type == \"delete\") {\r\n                // Delete the attribute\r\n                delete data[field];\r\n\r\n                // Send event to delete and update listeners\r\n                this.__emitEvent(type, path);\r\n                this.__emitEvent(\"update\", path, {\r\n                    type: \"delete\",\r\n                });\r\n            } else {\r\n                // Set the field to the new value\r\n                data[field] = value;\r\n\r\n                // Send event to (change or create) and update listeners\r\n                this.__emitEvent(type, path, {\r\n                    value: value,\r\n                });\r\n                this.__emitEvent(\"update\", path, {\r\n                    type: type,\r\n                    value: value,\r\n                });\r\n            }\r\n        }\r\n    }\r\n    /**\r\n     * Sends an event to the correct listeners with the correct data\r\n     * @param {('update'|'delete'|'create'|'change')} type - The type of event to emit\r\n     * @param {string} path - The path to the field for which to emit the event\r\n     * @param {Object} [event] - The event to emit\r\n     * @returns {undefined}\r\n     * @private\r\n     */\r\n    __emitEvent(type, path, event) {\r\n        // Create the event object if left out\r\n        if (!event) event = {};\r\n\r\n        // Add the full path, allData and type to the event\r\n        event.fullPath = path;\r\n        if (!event.type) event.type = type;\r\n        event.allData = this.data;\r\n\r\n        // Get all fields of the path\r\n        const pathParts = path.split(\".\");\r\n        let subPath = \"\"; // The path that we are currently at\r\n\r\n        // Go through all fields\r\n        while (true) {\r\n            // Get the listeners for the event type and check if they exist\r\n            let listeners = this.listeners[subPath + type];\r\n            if (listeners) {\r\n                // Set the path of the event relative from the current location\r\n                event.path = pathParts.join(\".\");\r\n\r\n                // Send the event to all listeners\r\n                listeners.forEach(listener => {\r\n                    listener.call(this, Object.assign({}, event));\r\n                });\r\n            }\r\n\r\n            // Check if the path has any fields left, if not break the loop\r\n            if (pathParts.length == 0) break;\r\n\r\n            // Go to the next field\r\n            subPath += pathParts.shift() + \".\";\r\n        }\r\n    }\r\n}\r\n"]}